<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Traffic Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #e0f7fa, #e1bee7);
        margin: 0;
        padding: 0;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        padding: 20px;
      }

      .container {
        width: 90%;
        max-width: 850px;
        margin: 20px auto;
        background: white;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .stat {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin: 8px 0;
      }

      canvas {
        margin-top: 25px;
      }

      .footer {
        text-align: center;
        margin-top: 20px;
        color: #777;
        font-size: 13px;
      }

      button {
        display: block;
        margin: 15px auto;
        padding: 10px 20px;
        background: #007bff;
        color: white;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
      }

      button:hover {
        background: #0056b3;
      }

      /* Symbol Recognizer Popup */
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
      }

      .popup-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 450px;
        position: relative;
        animation: fadeIn 0.4s ease;
      }

      @keyframes fadeIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #555;
      }

      input[type="file"] {
        display: block;
        margin: 20px auto;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 10px;
        width: 80%;
      }

      #preview {
        margin-top: 15px;
        border-radius: 10px;
        max-width: 80%;
        max-height: 200px;
      }

      #result {
        margin-top: 20px;
        background: #f0f9ff;
        padding: 15px;
        border-radius: 12px;
        font-weight: 600;
        color: #333;
      }
    </style>
  </head>

  <body>
    <h1>üìä Smart City Traffic Analytics</h1>

    <div class="container">
      <div id="stats">
        <p class="stat">Total Routes: <span id="total">0</span></p>
        <p class="stat">High Traffic: <span id="high">0</span></p>
        <p class="stat">Medium Traffic: <span id="medium">0</span></p>
        <p class="stat">Low Traffic: <span id="low">0</span></p>
        <p class="stat">Most Congested Route: <span id="worstRoute">-</span></p>
      </div>

      <canvas id="trafficChart" width="400" height="200"></canvas>

      <button onclick="window.location.href='traffic.html'">‚¨ÖÔ∏è Back to Traffic Map</button>
      <button onclick="openPopup()">üö¶ Symbol Recognizer</button>
    </div>

    <p class="footer">Auto-refreshes every 60 seconds ‚è±Ô∏è</p>

    <!-- Symbol Recognizer Popup -->
    <div class="popup" id="popup">
      <div class="popup-content">
        <button class="close-btn" onclick="closePopup()">‚úñ</button>
        <h2>üö¶ Traffic Symbol Recognizer</h2>
        <p><strong>Upload a traffic symbol image</strong><br>and I‚Äôll tell you what it means!</p>

        <input type="file" id="fileInput" accept="image/*" />
        <button onclick="recognizeSymbol()">üîç Recognize Symbol</button>

        <img id="preview" src="" alt="" />
        <div id="result"></div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAu7pDAiYNWGWXxCUom0_uiTx2omigT7Ec",
        authDomain: "smart-city-traffic-app-fa8f3.firebaseapp.com",
        projectId: "smart-city-traffic-app-fa8f3",
        storageBucket: "smart-city-traffic-app-fa8f3.appspot.com",
        messagingSenderId: "858416744357",
        appId: "1:858416744357:web:703b8145711372a04cca4c",
        measurementId: "G-TFTDBVWDH3"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const sheetURL =
        "https://script.google.com/macros/s/AKfycbzdAe7-CrAgqaH_TQdorGpHSsr2amBRB7VdHwWU74eCWMi7vLl49LxLJ2ah4cdRkHFI/exec";

      let chartInstance = null;

      async function loadAnalytics() {
        try {
          const res = await fetch(sheetURL);
          const data = await res.json();

          let total = data.length;
          let high = 0, medium = 0, low = 0;
          let routeCount = {};

          data.forEach((row) => {
            const level = row.Traffic_Level?.toLowerCase();
            if (level === "high") high++;
            else if (level === "medium") medium++;
            else if (level === "low") low++;

            const route = `${row.Start} ‚Üí ${row.End}`;
            if (level === "high") {
              routeCount[route] = (routeCount[route] || 0) + 1;
            }
          });

          let worstRoute = "-";
          if (Object.keys(routeCount).length > 0) {
            worstRoute = Object.entries(routeCount).sort((a, b) => b[1] - a[1])[0][0];
          }

          document.getElementById("total").textContent = total;
          document.getElementById("high").textContent = high;
          document.getElementById("medium").textContent = medium;
          document.getElementById("low").textContent = low;
          document.getElementById("worstRoute").textContent = worstRoute;

          const ctx = document.getElementById("trafficChart");
          if (chartInstance) chartInstance.destroy();
          chartInstance = new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["High", "Medium", "Low"],
              datasets: [
                {
                  label: "Traffic Levels",
                  data: [high, medium, low],
                  backgroundColor: ["#e74c3c", "#f39c12", "#27ae60"],
                },
              ],
            },
          });
        } catch (error) {
          console.error("Error loading analytics:", error);
        }
      }

      loadAnalytics();
      setInterval(loadAnalytics, 60000);
    </script>

    <script>
      const popup = document.getElementById("popup");
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      const resultDiv = document.getElementById("result");

      function openPopup() {
        popup.style.display = "flex";
      }

      function closePopup() {
        popup.style.display = "none";
        fileInput.value = "";
        preview.src = "";
        resultDiv.innerHTML = "";
      }

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (file) {
          preview.src = URL.createObjectURL(file);
          preview.style.display = "block";
          resultDiv.innerHTML = "";
        }
      });

      function recognizeSymbol() {
        if (!fileInput.files.length) {
          resultDiv.innerHTML = "‚ö†Ô∏è Please upload a traffic sign image first!";
          return;
        }

        const fileName = fileInput.files[0].name.toLowerCase();
        let description = "";

        if (fileName.includes("stop")) {
          description = "üõë <b>Stop Sign</b><br>Drivers must come to a complete stop and proceed only when safe.";
        } else if (fileName.includes("speed")) {
          description = "üöó <b>Speed Limit Sign</b><br>Indicates the maximum legal speed allowed on that road.";
        } else if (fileName.includes("u-turn") || fileName.includes("uturn")) {
          description = "‚Ü©Ô∏è <b>No U-Turn</b><br>Prohibits drivers from making a U-turn at this location.";
        } else if (fileName.includes("left")) {
          description = "‚¨ÖÔ∏è <b>No Left Turn</b><br>Drivers are not allowed to make a left turn here.";
        } else if (fileName.includes("right")) {
          description = "‚û°Ô∏è <b>No Right Turn</b><br>Drivers are not allowed to make a right turn here.";
        } else if (fileName.includes("parking")) {
          description = "üÖøÔ∏è <b>No Parking</b><br>Parking is not permitted in this area.";
        } else if (fileName.includes("pedestrian")) {
          description = "üö∂ <b>Pedestrian Crossing</b><br>Watch out for pedestrians crossing the road.";
        } else if (fileName.includes("school")) {
          description = "üè´ <b>School Zone</b><br>Drive slowly; children may be crossing the road.";
        } else if (fileName.includes("signal")) {
          description = "üö¶ <b>Traffic Signal Ahead</b><br>Prepare to stop or slow down as a signal is ahead.";
        } else if (fileName.includes("rail")) {
          description = "üöâ <b>Railway Crossing</b><br>Be alert; train crossing ahead.";
        } else {
          description = "‚ö†Ô∏è <b>Unrecognized Symbol</b><br>Unable to identify this traffic sign. Please upload a clearer image or include its name in the file.";
        }

        resultDiv.innerHTML = description;
      }
    </script>
  </body>
</html>
